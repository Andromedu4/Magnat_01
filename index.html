<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MaGnat ‚Äî created for Elizabeth</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --line:#1f2937; }
    *{box-sizing:border-box} body{margin:0; font-family:system-ui,Segoe UI,Roboto,sans-serif; background:linear-gradient(180deg,#0b1220,#0f172a);}
    .wrap{max-width:960px; margin:40px auto; padding:0 16px;}
    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.25);}
    h1{color:var(--text); font-size:26px; margin:0 0 8px}
    p.subtitle{color:var(--muted); margin:0 0 20px}
    .grid{display:grid; gap:16px}
    @media(min-width:840px){ .grid-2{grid-template-columns:1.2fr .8fr} }
    label{display:block; color:var(--muted); font-size:14px; margin-bottom:6px}
    select, textarea, input[type="range"]{
      width:100%; border:1px solid var(--line); background:#0b1020; color:var(--text);
      border-radius:12px; padding:10px; outline:none;
    }
    textarea{min-height:180px; resize:vertical; line-height:1.5}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      appearance:none; border:1px solid var(--line); background:#111b34; color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; transition:.15s transform, .15s opacity;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn.primary{background:#1f3a78}
    .ctrl{display:grid; gap:12px}
    .range-row{display:grid; grid-template-columns:1fr 70px; gap:10px; align-items:center}
    .hint{color:var(--muted); font-size:13px}
    .pill{font-size:12px; color:#cbd5e1; background:#0b1222; border:1px solid var(--line); padding:4px 8px; border-radius:999px}
    .footer{margin-top:12px; color:var(--muted); font-size:12px}
    .link{color:#a5b4fc; text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>MaGnat ‚Äî for Elizabeth</h1>
      <p class="subtitle"></p>

      <div class="grid grid-2">
        <div class="grid">
          <div>
            <label for="lang">–ú–æ–≤–∞</label>
            <select id="lang">
              <option value="en-GB">English (UK)</option>
            </select>
            <div class="hint">–ü—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –º–æ–≤–∏ ‚Äî –æ–±–µ—Ä—ñ—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –≥–æ–ª–æ—Å.</div>
          </div>

          <div>
            <label for="voice">–ì–æ–ª–æ—Å</label>
            <select id="voice">
              <option>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥–æ–ª–æ—Å—ñ–≤‚Ä¶</option>
            </select>
          </div>

          <div>
            <label for="text">–¢–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–µ–Ω–Ω—è</label>
            <textarea id="text" placeholder="–í—Å—Ç–∞–≤—Ç–µ –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é (–∞–±–æ —ñ–Ω—à–æ—é –º–æ–≤–æ—é) —Ç—É—Ç...">AI can help us learn pronunciation by reading aloud any text we paste here. Try changing the rate and pitch to match your preference.</textarea>
            <div class="row" style="margin-top:8px">
              <span class="pill" id="charCount">0 symbols</span>
              <span class="pill" id="wordCount">0 words</span>
            </div>
          </div>
        </div>

        <div class="ctrl">
          <div>
            <label>–®–≤–∏–¥–∫—ñ—Å—Ç—å (Rate)</label>
            <div class="range-row">
              <input id="rate" type="range" min="0.5" max="2" step="0.1" value="1" />
              <span class="pill" id="rateVal">1.0√ó</span>
            </div>
          </div>
          <div>
            <label>–í–∏—Å–æ—Ç–∞ (Pitch)</label>
            <div class="range-row">
              <input id="pitch" type="range" min="0" max="2" step="0.1" value="1" />
              <span class="pill" id="pitchVal">1.0</span>
            </div>
          </div>
          <div>
            <label>–ì—É—á–Ω—ñ—Å—Ç—å (Volume)</label>
            <div class="range-row">
              <input id="volume" type="range" min="0" max="1" step="0.1" value="1" />
              <span class="pill" id="volVal">100%</span>
            </div>
          </div>

          <div class="row" style="margin-top:6px">
            <button class="btn primary" id="playBtn">‚ñ∂Ô∏è –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏</button>
            <button class="btn" id="pauseBtn">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
            <button class="btn" id="resumeBtn">‚èØÔ∏è –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
            <button class="btn" id="stopBtn">‚èπÔ∏è –°—Ç–æ–ø</button>
          </div>

          <hr style="border:0; border-top:1px solid var(--line)">

          <div>
            <label>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∞—É–¥—ñ–æ</label>
            <div class="hint" style="margin-bottom:8px">
              –ö–Ω–æ–ø–∫–∞ –Ω–∏–∂—á–µ —Ç–∏–º—á–∞—Å–æ–≤–æ <b>–∑–∞–ø–∏—Å—É—î –∑–≤—É–∫ –≤–∫–ª–∞–¥–∫–∏</b> –ø—ñ–¥ —á–∞—Å –æ–∑–≤—É—á–µ–Ω–Ω—è —ñ –∑–±–µ—Ä—ñ–≥–∞—î —Ñ–∞–π–ª <code>.webm</code>.
            </div>
            <div class="row">
              <button class="btn" id="recBtn">üî¥ –ó–∞–ø–∏—Å–∞—Ç–∏ —ñ —Å–∫–∞—á–∞—Ç–∏</button>
              <a id="downloadLink" class="btn link" style="display:none" download="tts_recording.webm">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª</a>
            </div>
            <div class="hint" id="recHint"></div>
          </div>
        </div>
      </div>

      <div class="footer">
        –ü–æ—Ä–∞–¥–∞: –±—Ä–∞—É–∑–µ—Ä–Ω—ñ –≥–æ–ª–æ—Å–∏ –≤—ñ–¥—Ä—ñ–∑–Ω—è—é—Ç—å—Å—è. –Ø–∫—â–æ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–∏–π ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏¬ª –æ–¥–∏–Ω —Ä–∞–∑ –∞–±–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É, —â–æ–± <code>speechSynthesis</code> —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞–≤—Å—è.
      </div>
    </div>
  </div>

<script>
  // --- Elements
  const langSel = document.getElementById('lang');
  const voiceSel = document.getElementById('voice');
  const textEl  = document.getElementById('text');
  const rateEl  = document.getElementById('rate');
  const pitchEl = document.getElementById('pitch');
  const volEl   = document.getElementById('volume');
  const rateVal = document.getElementById('rateVal');
  const pitchVal= document.getElementById('pitchVal');
  const volVal  = document.getElementById('volVal');

  const playBtn   = document.getElementById('playBtn');
  const pauseBtn  = document.getElementById('pauseBtn');
  const resumeBtn = document.getElementById('resumeBtn');
  const stopBtn   = document.getElementById('stopBtn');

  const recBtn       = document.getElementById('recBtn');
  const recHint      = document.getElementById('recHint');
  const downloadLink = document.getElementById('downloadLink');

  const charCount = document.getElementById('charCount');
  const wordCount = document.getElementById('wordCount');

  let voices = [];
  let currentUtterance = null;
  let mediaRecorder = null;
  let recordedChunks = [];

  // --- Helpers
  function updateCounters() {
    const t = textEl.value || "";
    charCount.textContent = `${t.length} symbols`;
    const words = t.trim().split(/\s+/).filter(Boolean);
    wordCount.textContent = `${words.length} words`;
  }
  updateCounters();
  textEl.addEventListener('input', updateCounters);

  // –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–π –≥–æ–ª–æ—Å ‚Äî –æ–¥–∏–Ω
  const VOICE_WHITELIST = [/Google UK English Male/i];

  function isAllowedVoice(v) {
    return VOICE_WHITELIST.some(rule =>
      typeof rule === 'string' ? v.name === rule : rule.test(v.name)
    );
  }

  // –û–°–¢–ê–í–õ–Ø–ï–ú –¢–û–õ–¨–ö–û "Google UK English Male"
  function populateVoices() {
    voices = speechSynthesis.getVoices() || [];

    // 1) –ò—â–µ–º whitelisted –≥–æ–ª–æ—Å
    let arr = voices.filter(isAllowedVoice);

    // 2) –ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç ‚Äî –ø—Ä–æ–±—É–µ–º –ª—é–±–æ–π Google-–≥–æ–ª–æ—Å en-GB (–ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞)
    if (!arr.length) {
      arr = voices.filter(v => /Google/i.test(v.name) && (v.lang || '').startsWith('en-GB'));
    }

    voiceSel.innerHTML = '';
    if (!arr.length) {
      // 3) –°–æ–≤—Å–µ–º –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö ‚Äî —Å–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      const opt = document.createElement('option');
      opt.textContent = 'Voice not found (need Google UK English Male)';
      opt.value = '';
      voiceSel.appendChild(opt);
      return;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –¢–û–õ–¨–ö–û –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π (—Ç–æ –µ—Å—Ç—å –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç)
    const v = arr[0];
    const opt = document.createElement('option');
    opt.value = v.name;
    opt.textContent = `${v.name} ‚Äî ${v.lang}`;
    voiceSel.appendChild(opt);
    voiceSel.selectedIndex = 0;
  }

  // Try to load voices (Chrome fires onvoiceschanged)
  populateVoices();
  window.speechSynthesis.onvoiceschanged = populateVoices;
  langSel.addEventListener('change', populateVoices);

  // Sliders UI
  function fmt(n, suf='') { return (''+Number(n).toFixed(suf ? 0 : 1)) + suf; }
  rateEl.addEventListener('input', () => rateVal.textContent = fmt(rateEl.value)+'√ó');
  pitchEl.addEventListener('input', () => pitchVal.textContent = fmt(pitchEl.value,''));
  volEl.addEventListener('input', () => volVal.textContent = fmt(volEl.value*100,0)+'%');
  rateVal.textContent = '1.0√ó'; pitchVal.textContent='1.0'; volVal.textContent='100%';

  // Build utterance
  function makeUtterance() {
    const u = new SpeechSynthesisUtterance(textEl.value);

    // –∂—ë—Å—Ç–∫–æ –≤—ã–±–∏—Ä–∞–µ–º –Ω—É–∂–Ω—ã–π –≥–æ–ª–æ—Å –ø–æ –∏–º–µ–Ω–∏; –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –∏–∑ select/—Å–ø–∏—Å–∫–∞
    const prefer = voices.find(v => /Google UK English Male/i.test(v.name));
    const bySelect = voices.find(v => v.name === voiceSel.value);
    const v = prefer || bySelect || voices[0];

    if (v) {
      u.voice = v;
      u.lang  = v.lang || 'en-GB';
    }
    u.rate = parseFloat(rateEl.value);
    u.pitch = parseFloat(pitchEl.value);
    u.volume = parseFloat(volEl.value);
    u.onend = () => { currentUtterance = null; };
    u.onerror = (e) => { console.error('TTS error', e); currentUtterance = null; };
    return u;
  }

  function speak() {
    stop(); // clear queue
    const txt = textEl.value.trim();
    if (!txt) return;
    const u = makeUtterance();
    currentUtterance = u;
    speechSynthesis.speak(u);
  }

  function pause() {
    if (speechSynthesis.speaking && !speechSynthesis.paused) speechSynthesis.pause();
  }
  function resume() {
    if (speechSynthesis.paused) speechSynthesis.resume();
  }
  function stop() {
    speechSynthesis.cancel();
    currentUtterance = null;
  }

  playBtn.addEventListener('click', speak);
  pauseBtn.addEventListener('click', pause);
  resumeBtn.addEventListener('click', resume);
  stopBtn.addEventListener('click', stop);

  // --- Record & Download (captures TAB audio while TTS is playing)
  async function recordAndDownload() {
    try {
      recordedChunks = [];
      downloadLink.style.display = 'none';
      recHint.textContent = '–ó–∞–ø–∏—Ç—É—î–º–æ –¥–æ–∑–≤—ñ–ª –Ω–∞ –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è –∑–≤—É–∫—É –≤–∫–ª–∞–¥–∫–∏‚Ä¶';

      const stream = await navigator.mediaDevices.getDisplayMedia({
        video: false,
        audio: { echoCancellation: false, noiseSuppression: false }
      });

      if (!stream.getAudioTracks().length) {
        recHint.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—å –æ—Ç—Ä–∏–º–∞—Ç–∏ –∞—É–¥—ñ–æ –∑ –≤–∫–ª–∞–¥–∫–∏. –û–±–µ—Ä—ñ—Ç—å —É –≤—ñ–∫–Ω—ñ —Å–∞–º–µ —Ü—é –≤–∫–ª–∞–¥–∫—É —ñ –¥–æ–∑–≤–æ–ª—å—Ç–µ –∑–≤—É–∫.';
        return;
      }

      recHint.textContent = '–ó–∞–ø–∏—Å –ø—ñ—à–æ–≤. –ü–æ—á–∏–Ω–∞—é –æ–∑–≤—É—á–µ–Ω–Ω—è‚Ä¶';
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

      mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.style.display = 'inline-block';
        recHint.textContent = '–ì–æ—Ç–æ–≤–æ! –ó–±–µ—Ä–µ–∂—ñ—Ç—å —Ñ–∞–π–ª.';
        stream.getTracks().forEach(t => t.stop());
      };

      mediaRecorder.start();

      // Speak now
      stop(); // just in case
      const u = makeUtterance();
      u.onend = () => { setTimeout(() => mediaRecorder.stop(), 150); };
      speechSynthesis.speak(u);

    } catch (err) {
      console.error(err);
      recHint.textContent = '–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∑–∞–ø–∏—Å—É –≤–∫–ª–∞–¥–∫–∏. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π –±—Ä–∞—É–∑–µ—Ä –∞–±–æ –¥–æ–∑–≤–æ–ª—å—Ç–µ –∑–≤—É–∫ –≤–∫–ª–∞–¥–∫–∏.';
    }
  }

  recBtn.addEventListener('click', recordAndDownload);
</script>

</body>
</html>
